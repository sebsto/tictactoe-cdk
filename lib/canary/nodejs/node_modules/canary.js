var synthetics = require('Synthetics');
const log = require('SyntheticsLogger');

/*
In order to create a game, we need to:

1. Log in with a POST to /index.  Must includes `username` as form data.
2. Create table with GET to /table
3. Make a POST to /play

*/
const loginAndPlayBlueprint = async function () {

    let url = "http://" + process.env.ENDPOINT;

    let page = await synthetics.getPage();

    // Navigate to the url
    await synthetics.executeStep('login', async function (timeoutInMillis = 30000) {
        await page.goto(url + "/index", {waitUntil: ['load', 'networkidle0'], timeout: timeoutInMillis});
        const element = await page.$('[name="username"]');
        await element.type('canary');
        const form = await page.$('.navbar-right');
        await form.evaluate(form => form.submit());
        log.info("Logged in");
    });
    await synthetics.executeStep('create', async function (timeoutInMillis = 30000) {
        const btn = await page.$('[href="/create"]');
        await btn.click();
        await page.waitForNavigation();
        log.info("Hit create");
    });
    await synthetics.executeStep('play', async function (timeoutInMillis = 30000) {
        //await page.goto(url + "/create", {waitUntil: ['load', 'networkidle0'], timeout: timeoutInMillis});
        const elementO = await page.$('[name="invitee"]');
        await elementO.type('opponent');
        const formO = await page.$('.test');
        await formO.evaluate(formO => formO.submit());
        await page.waitForNavigation();
        log.info("Started a game");
    });


};

exports.handler = async () => {
    return await loginAndPlayBlueprint();
};
